import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout';
import { Head, Link, router } from '@inertiajs/react';
import { useEffect, useState } from 'react';
import ProjectCard from '@/Components/ProjectCard';
import StatsGrid from '@/Components/StatsGrid';
import FilterPanel from '@/Components/FilterPanel';
import EmptyState from '@/Components/EmptyState';
import Pagination from '@/Components/Pagination';

export default function Index({ auth, projects, filters }) {
    const [search, setSearch] = useState(filters.search || '');
    const [status, setStatus] = useState(filters.status || '');
    const [showFilters, setShowFilters] = useState(!!(filters.search || filters.status));

    // –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É —Å –¥–µ–±–∞—É–Ω—Å–æ–º
    useEffect(() => {
        const timeoutId = setTimeout(() => {
            router.get(route('projects.index'), { search, status }, {
                preserveState: true,
                preserveScroll: true,
                replace: true,
            });
        }, 300);

        return () => clearTimeout(timeoutId);
    }, [search, status]);

    const handleStatusChange = (e) => {
        setStatus(e.target.value);
    };

    const clearFilters = () => {
        setSearch('');
        setStatus('');
        setShowFilters(false);
        router.get(route('projects.index'), {}, {
            preserveState: true,
            preserveScroll: true,
        });
    };

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
    const getProjectStats = () => {
        const allProjects = projects.data;
        return {
            total: allProjects.length,
            active: allProjects.filter(p => p.status === 'active').length,
            completed: allProjects.filter(p => p.status === 'completed').length,
            onHold: allProjects.filter(p => p.status === 'on_hold').length,
            cancelled: allProjects.filter(p => p.status === 'cancelled').length,
        };
    };

    const stats = getProjectStats();

    return (
        <AuthenticatedLayout
            user={auth.user}
            header={<h2 className="font-semibold text-xl text-text-primary leading-tight">–ü—Ä–æ–µ–∫—Ç—ã</h2>}
        >
            <Head title="–ü—Ä–æ–µ–∫—Ç—ã" />

            <div className="space-y-6">
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è */}
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-text-primary">–ü—Ä–æ–µ–∫—Ç—ã</h1>
                        <p className="text-text-secondary mt-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ –∑–∞–¥–∞—á–∞–º–∏</p>
                    </div>
                    <div className="flex space-x-3">
                        <button
                            onClick={() => setShowFilters(!showFilters)}
                            className="btn btn-secondary inline-flex items-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                            </svg>
                            –§–∏–ª—å—Ç—Ä—ã
                        </button>
                        <Link
                            href={route('projects.create')}
                            className="btn btn-primary inline-flex items-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                        </Link>
                    </div>
                </div>

                {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                <StatsGrid 
                    columns={5}
                    stats={[
                        { label: '–í—Å–µ–≥–æ', value: stats.total, color: 'text-text-primary' },
                        { label: '–ê–∫—Ç–∏–≤–Ω—ã—Ö', value: stats.active, color: 'text-accent-green' },
                        { label: '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö', value: stats.completed, color: 'text-accent-blue' },
                        { label: '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö', value: stats.onHold, color: 'text-accent-yellow' },
                        { label: '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö', value: stats.cancelled, color: 'text-accent-red' },
                    ]}
                />

                {/* –§–∏–ª—å—Ç—Ä—ã */}
                <FilterPanel
                    isVisible={showFilters}
                    onClearFilters={clearFilters}
                    searchConfig={{
                        label: '–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é',
                        value: search,
                        onChange: setSearch,
                        placeholder: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...'
                    }}
                    filters={[
                        {
                            type: 'select',
                            label: '–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞',
                            value: status,
                            onChange: handleStatusChange,
                            options: [
                                { value: '', label: '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã' },
                                { value: 'active', label: '–ê–∫—Ç–∏–≤–Ω—ã–π' },
                                { value: 'completed', label: '–ó–∞–≤–µ—Ä—à–µ–Ω' },
                                { value: 'on_hold', label: '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' },
                                { value: 'cancelled', label: '–û—Ç–º–µ–Ω–µ–Ω' }
                            ]
                        }
                    ]}
                />

                {/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –ø–æ–∏—Å–∫—É */}
                {(search || status) && projects.data.length === 0 && (
                    <div className="card bg-gradient-to-r from-accent-yellow/10 to-accent-orange/10 border-accent-yellow/20">
                        <div className="flex items-start space-x-3">
                            <div className="text-accent-yellow text-xl">üí°</div>
                            <div>
                                <h3 className="font-medium text-text-primary mb-1">–°–æ–≤–µ—Ç—ã –ø–æ –ø–æ–∏—Å–∫—É</h3>
                                <div className="text-sm text-text-secondary space-y-1">
                                    <p>‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞</p>
                                    <p>‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –æ–±—â–∏–µ —Ç–µ—Ä–º–∏–Ω—ã</p>
                                    <p>‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å</p>
                                    <p>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <button onClick={clearFilters} className="text-accent-blue hover:underline">–æ—á–∏—Å—Ç–∫—É —Ñ–∏–ª—å—Ç—Ä–æ–≤</button> –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞</p>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ */}
                {projects.data.length > 0 ? (
                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold text-text-primary">
                                –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {projects.data.length}
                            </h3>
                            <div className="text-sm text-text-secondary">
                                {search && `–ü–æ–∏—Å–∫: "${search}"`}
                                {status && ` ‚Ä¢ –°—Ç–∞—Ç—É—Å: ${status}`}
                            </div>
                        </div>
                        <div className="grid-cards">
                            {projects.data.map((project) => (
                                <ProjectCard key={project.id} project={project} />
                            ))}
                        </div>
                    </div>
                ) : (
                    <EmptyState 
                        title={search || status ? '–ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' : '–ü—Ä–æ–µ–∫—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}
                        description={search || status 
                            ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã' 
                            : '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏'
                        }
                        hasFilters={!!(search || status)}
                        onClearFilters={clearFilters}
                        action={!search && !status ? {
                            href: route('projects.create'),
                            text: '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç',
                            icon: 'M12 6v6m0 0v6m0-6h6m-6 0H6'
                        } : null}
                    />
                )}

                {/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */}
                <Pagination data={projects} />
            </div>
        </AuthenticatedLayout>
    );
} 