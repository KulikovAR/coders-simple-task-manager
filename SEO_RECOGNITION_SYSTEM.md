# SEO Recognition System

## Обзор

Реализована стабильная система обработки распознавания для SEO раздела с использованием джобов, отслеживанием статуса и обновлением фронтенда в реальном времени.

## Архитектура

### Backend

#### Модели
- **SeoRecognitionTask** - модель для отслеживания задач распознавания
  - Статусы: `pending`, `processing`, `completed`, `failed`
  - Отслеживание прогресса: `total_keywords`, `processed_keywords`
  - Временные метки: `started_at`, `completed_at`

#### Джобы
- **ProcessSeoRecognitionJob** - основная джоба для обработки распознавания
  - Обрабатывает один сайт за раз
  - Поддерживает повторные попытки (3 попытки с задержками)
  - Логирование всех операций
  - Обработка ошибок

#### Сервисы
- **RecognitionTaskService** - управление задачами распознавания
  - Создание новых задач
  - Получение активных задач
  - Очистка старых задач

#### Контроллеры
- **SeoStatsController** - обновлен для работы с новой системой
  - `trackPositions()` - запуск распознавания
  - `getRecognitionStatus()` - получение статуса для сайта
  - `getTaskStatus()` - получение статуса конкретной задачи

#### API Endpoints
- `POST /seo-stats/{site}/track-positions` - запуск распознавания
- `GET /seo-stats/{site}/recognition-status` - статус распознавания для сайта
- `GET /seo-stats/tasks/{task}/status` - статус конкретной задачи

### Frontend

#### Хуки
- **useSeoRecognition** - основной хук для работы с распознаванием
  - Автоматический опрос статуса каждую секунду
  - Сохранение состояния в localStorage
  - Восстановление состояния при перезагрузке

#### Компоненты
- **RecognitionStatus** - компонент отображения статуса распознавания
  - Прогресс-бар с процентами
  - Индикаторы состояния
  - Кнопки управления
  - Обработка ошибок

#### Обновленные компоненты
- **ProjectCard** - интегрирован с новой системой распознавания
- **Reports** - использует новый компонент RecognitionStatus

## Особенности

### Стабильность
- Один ресурс - одна джоба (изоляция задач)
- Повторные попытки при ошибках
- Детальное логирование
- Автоматическая очистка старых задач

### UX
- Реальное время обновления (каждую секунду)
- Сохранение состояния при перезагрузке
- Визуальные индикаторы прогресса
- Обработка ошибок с возможностью повтора

### Производительность
- Асинхронная обработка через очереди
- Минимальная нагрузка на фронтенд
- Автоматическая очистка данных

## Использование

### Запуск распознавания
```javascript
const { startRecognition } = useSeoRecognition(siteId);
const result = await startRecognition();
```

### Отслеживание статуса
```javascript
const { recognitionStatus, isPolling } = useSeoRecognition(siteId);
// Автоматически обновляется каждую секунду
```

### Компонент статуса
```jsx
<RecognitionStatus 
    siteId={project.id} 
    onComplete={handleRefreshData}
/>
```

## Команды

### Очистка старых задач
```bash
php artisan seo:cleanup-tasks
```

Команда автоматически выполняется ежедневно в 03:00.

## Миграции

Создана таблица `seo_recognition_tasks` для отслеживания задач:
- `id` - первичный ключ
- `user_id` - пользователь
- `site_id` - ID сайта
- `status` - статус задачи
- `search_engines` - поисковые системы (JSON)
- `total_keywords` - общее количество ключевых слов
- `processed_keywords` - обработанное количество
- `error_message` - сообщение об ошибке
- `started_at` - время начала
- `completed_at` - время завершения
- `created_at`, `updated_at` - временные метки

## Очереди

Джобы обрабатываются в очереди `seo-recognition`:
- Таймаут: 300 секунд
- Попытки: 3
- Задержки между попытками: 30, 60, 120 секунд
